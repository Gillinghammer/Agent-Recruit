extends layout

block content
  div(class="inner cover")
    h3(class="cover-heading") Check-in at these locations
    .panel.panel-default
      .panel-body
        img(src="/images/pinkdoor.jpg", width="350px")
        br
        br
        button(id="send", class="btn btn-primary btn-lg") Send Coordinates
      .panel-footer
        p#response
        p#error
  script.
    var savedLat = 51.514990
    var savedLong = -0.199630
    var x = document.getElementById("response");


    $(document).ready(function(){
      $.post( "/start", function( data ) {
        console.log('req sent to start timer')
      });
        $('#send').on('click touchstart', function() {
            getLocation();
        });
    });


    function getLocation() {

      if (navigator.geolocation) {
        //- navigator.geolocation.getCurrentPosition(showPosition());
        navigator.geolocation.getCurrentPosition(showPosition);
      } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
      }
    }
    function showPosition(position) {
      var distance = getDistanceFromLatLonInKm(savedLat,savedLong,position.coords.latitude,position.coords.longitude)
      x.innerHTML = "<br>You are " + Math.round((distance*1000)) + " meters away.";
      submitDistance(distance)
    }
    function submitDistance(distance) {
    console.log("distance! ", distance)
      if(distance <= .05 ){
        $.ajax({
          url: '3',
          type: 'POST',
          data: { distance: distance },
          dataType: 'json',
          success: function (data) {
            window.location = "/"
            }
          })
      } else {
        $('#error').text("Not close enough yet... No Cheating!")
      }
      
    }
    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
      var R = 6371; // Radius of the earth in km
      var dLat = deg2rad(lat2-lat1);  // deg2rad below
      var dLon = deg2rad(lon2-lon1); 
      var a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2)
        ; 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      var d = R * c; // Distance in km
      return d;
    }

    function deg2rad(deg) {
      return deg * (Math.PI/180)
    }